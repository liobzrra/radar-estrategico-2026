<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radar Estratégico Pro | v5.3 Stable</title>
    
    <!-- 1. Carregamento de Bibliotecas (Versões Estáveis UMD) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configuração do Tailwind (Deve vir logo após o script do Tailwind) -->
    <script>
        // Verificação de segurança para o Tailwind
        if (typeof tailwind !== 'undefined') {
            tailwind.config = {
                theme: {
                    extend: {
                        colors: {
                            slate: { 850: '#151e32', 900: '#0f172a' },
                            aero: { light: '#38bdf8', DEFAULT: '#0284c7', dark: '#0c4a6e' },
                            def: { light: '#84cc16', DEFAULT: '#4d7c0f', dark: '#365314' },
                        },
                        fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                        animation: {
                            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                            'spin-slow': 'spin 2s linear infinite',
                            'fade-in': 'fadeIn 0.5s ease-out forwards'
                        },
                        keyframes: {
                            fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                        }
                    }
                }
            }
        }
    </script>

    <!-- Chart.js (Versão UMD para garantir variável global 'Chart') -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <!-- Fontes e Ícones -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { background-color: #f8fafc; color: #0f172a; overflow-x: hidden; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(16px); border-bottom: 1px solid rgba(226, 232, 240, 0.8); }
        
        /* Card Pro Design */
        .pro-card {
            background: white; border: 1px solid #e2e8f0; border-radius: 2rem;
            transition: all 0.4s ease; position: relative; overflow: hidden;
        }
        .pro-card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px -12px rgba(2, 132, 199, 0.1); border-color: #0284c7; }
        
        /* Modal */
        #newsModal .modal-content { max-height: 92vh; width: 95vw; max-width: 1200px; border-radius: 3rem; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .loading-bar { height: 3px; background: linear-gradient(90deg, #0284c7, #4d7c0f); width: 0%; transition: width 0.3s; position: fixed; top: 0; left: 0; z-index: 100; }
        .text-justify { text-align: justify; }
    </style>
</head>
<body class="antialiased font-sans">

    <div id="loadingLine" class="loading-bar"></div>

    <!-- HEADER -->
    <header class="glass-panel sticky top-0 z-50 h-24 flex items-center justify-between px-6 lg:px-12 shadow-sm">
        <div class="flex items-center gap-5">
            <div class="w-12 h-12 bg-slate-900 rounded-2xl flex items-center justify-center text-white shadow-xl">
                <i class="fa-solid fa-brain text-2xl"></i>
            </div>
            <div>
                <h1 class="text-xl font-black tracking-tighter uppercase text-slate-900 leading-none">Radar Estratégico <span class="text-aero-DEFAULT text-xs align-top">PRO v3</span></h1>
                <p class="text-[10px] font-bold text-slate-400 tracking-[0.25em] uppercase mt-1">DAAE Intelligence Hub</p>
            </div>
        </div>

        <div class="flex items-center gap-6">
            <button onclick="openConfig()" class="w-10 h-10 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-slate-500 transition-colors" title="Configurar Chave API">
                <i class="fa-solid fa-gear"></i>
            </button>

            <button onclick="syncWithAI()" id="syncBtn" class="flex items-center gap-3 bg-slate-900 hover:bg-aero-DEFAULT text-white px-6 py-3 rounded-2xl transition-all shadow-xl hover:shadow-aero-DEFAULT/30 group">
                <i id="syncIcon" class="fa-solid fa-rotate text-sm group-hover:rotate-180 transition-transform duration-700"></i>
                <div class="text-left leading-none">
                    <span class="block text-[9px] font-bold text-slate-400 group-hover:text-white/80 uppercase tracking-wider">Agente IA</span>
                    <span id="syncText" class="text-xs font-black uppercase tracking-wide">Sincronizar</span>
                </div>
            </button>
        </div>
    </header>

    <!-- Overlay de Carregamento IA -->
    <div id="aiOverlay" class="hidden fixed inset-0 z-40 bg-slate-900/90 backdrop-blur-md flex items-center justify-center p-6">
        <div class="bg-white rounded-[3rem] p-12 max-w-2xl w-full shadow-2xl text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-aero-DEFAULT to-def-DEFAULT animate-pulse"></div>
            <div class="w-24 h-24 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-8 relative">
                <i class="fa-solid fa-microchip text-4xl text-aero-DEFAULT animate-pulse"></i>
                <div class="absolute inset-0 border-4 border-aero-DEFAULT/20 rounded-full border-t-aero-DEFAULT animate-spin"></div>
            </div>
            <h2 class="text-3xl font-black text-slate-900 mb-4">Varredura e Sanitização</h2>
            <p id="aiStatusText" class="text-slate-500 font-medium text-lg">Processando resposta neural...</p>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 lg:px-8 py-12">
        
        <!-- Dashboard Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-16">
            <!-- Chart 1 -->
            <div class="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-sm flex flex-col h-[420px]">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h3 class="text-sm font-black text-slate-800 uppercase tracking-wide">Densidade Temporal</h3>
                        <p class="text-[10px] text-slate-400 font-bold uppercase">Volume de eventos (Jan 2026)</p>
                    </div>
                    <span class="px-3 py-1 bg-slate-50 rounded-lg text-[10px] font-black text-slate-400">TIMELINE</span>
                </div>
                <div class="flex-1 relative w-full h-full">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>

            <!-- Chart 2 -->
            <div class="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-sm flex flex-col h-[420px]">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h3 class="text-sm font-black text-slate-800 uppercase tracking-wide">Matriz Estratégica</h3>
                        <p class="text-[10px] text-slate-400 font-bold uppercase">Impacto vs. Maturidade (TRL)</p>
                    </div>
                    <span class="px-3 py-1 bg-slate-50 rounded-lg text-[10px] font-black text-slate-400">SCATTER</span>
                </div>
                <div id="strategicMap" class="flex-1 w-full h-full"></div>
            </div>
        </div>

        <!-- Filters & Search -->
        <div class="sticky top-28 z-30 mb-12">
            <div class="bg-white/80 backdrop-blur-xl p-3 rounded-[2rem] shadow-xl border border-white/50 flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex bg-slate-100/80 p-1.5 rounded-2xl w-full md:w-auto">
                    <button onclick="filterData('all')" id="tab-all" class="flex-1 md:flex-none px-8 py-3 rounded-xl text-xs font-black transition-all bg-white text-slate-900 shadow-sm">GERAL</button>
                    <button onclick="filterData('aero')" id="tab-aero" class="flex-1 md:flex-none px-8 py-3 rounded-xl text-xs font-black transition-all text-slate-500 hover:text-aero-DEFAULT">AERO</button>
                    <button onclick="filterData('defense')" id="tab-defense" class="flex-1 md:flex-none px-8 py-3 rounded-xl text-xs font-black transition-all text-slate-500 hover:text-def-DEFAULT">DEFESA</button>
                </div>
                <div class="w-full md:w-[500px] relative">
                    <i class="fa-solid fa-search absolute left-5 top-4 text-slate-400 text-sm"></i>
                    <input type="text" id="searchInput" placeholder="Pesquisar nos relatórios de inteligência..." 
                        class="w-full bg-white border-0 text-slate-800 text-xs font-bold rounded-2xl py-4 pl-12 pr-6 focus:ring-2 focus:ring-slate-900 shadow-inner">
                </div>
            </div>
        </div>

        <!-- News Grid -->
        <div id="newsGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8">
            <!-- Injected via JS -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden flex-col items-center justify-center py-40 text-center opacity-50">
            <i class="fa-solid fa-layer-group text-6xl text-slate-200 mb-6"></i>
            <h3 class="text-xl font-black text-slate-300 uppercase">Sem dados nos parâmetros</h3>
        </div>

    </main>

    <!-- Modal Config API -->
    <div id="configModal" class="hidden fixed inset-0 z-[70] bg-slate-900/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl animate-fade-in">
            <h3 class="text-xl font-black text-slate-900 mb-4">Configuração do Agente</h3>
            <p class="text-sm text-slate-500 mb-6 text-justify">Para habilitar a busca, insira sua chave API do Google Gemini.</p>
            <input type="password" id="apiKeyInput" placeholder="Cole sua API Key aqui..." class="w-full bg-slate-50 border border-slate-200 rounded-xl p-4 text-sm mb-4 focus:ring-2 focus:ring-aero-DEFAULT outline-none">
            <div class="flex gap-3">
                <button onclick="saveConfig()" class="flex-1 bg-slate-900 text-white py-3 rounded-xl font-bold text-sm hover:bg-aero-DEFAULT transition-colors">Salvar e Ativar</button>
                <button onclick="document.getElementById('configModal').classList.add('hidden')" class="px-6 py-3 rounded-xl font-bold text-sm text-slate-500 hover:bg-slate-100">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal Notícia -->
    <div id="newsModal" class="hidden fixed inset-0 z-[60] bg-slate-900/80 backdrop-blur-md flex items-center justify-center p-4">
        <div class="modal-content bg-white w-full h-full shadow-2xl flex flex-col lg:flex-row overflow-hidden relative">
            <button onclick="closeModal()" class="absolute top-8 right-8 z-10 w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center text-slate-400 hover:bg-slate-900 hover:text-white transition-all">
                <i class="fa-solid fa-times text-xl"></i>
            </button>

            <div class="flex-1 p-10 lg:p-16 overflow-y-auto">
                <div class="flex gap-3 mb-8">
                    <span id="modalSector" class="px-4 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-widest border"></span>
                    <span id="modalScope" class="px-4 py-1.5 bg-slate-100 text-slate-500 rounded-lg text-[10px] font-black uppercase tracking-widest"></span>
                </div>

                <h2 id="modalTitle" class="text-3xl lg:text-5xl font-black text-slate-900 leading-[1.1] tracking-tight mb-10"></h2>

                <div id="modalBody" class="space-y-8 text-slate-600 text-base lg:text-lg leading-relaxed text-justify font-medium"></div>

                <div class="mt-16 pt-10 border-t border-slate-100 flex items-center justify-between">
                    <div>
                        <p class="text-[10px] font-black text-slate-300 uppercase tracking-widest mb-1">Fonte</p>
                        <p id="modalSource" class="text-xl font-black text-slate-900"></p>
                    </div>
                    <div id="modalDate" class="text-xs font-mono text-slate-400 bg-slate-50 px-6 py-3 rounded-xl border border-slate-100"></div>
                </div>
            </div>

            <div class="lg:w-[420px] bg-slate-50 border-l border-slate-100 p-10 lg:p-16 flex flex-col justify-center items-center text-center">
                <div class="bg-white p-4 rounded-3xl shadow-xl border border-slate-100 mb-10">
                    <div id="qrcode"></div>
                </div>
                <a id="modalLink" href="#" target="_blank" class="w-full bg-slate-900 text-white font-black text-xs uppercase tracking-[0.2em] py-5 rounded-2xl hover:bg-aero-DEFAULT hover:shadow-xl hover:shadow-aero-DEFAULT/20 transition-all transform hover:-translate-y-1">
                    Acessar Fonte Original
                </a>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- 1. BASE DE DADOS INICIAL (14 ITENS) ---
        const initialData = [
            { id: 1, title: "Nota Oficial: Anomalia e Perda Total do Aldebaran-I", sector: "aero", scope: "national", date: "12/01/2026", impact: 10, readiness: 1, source: "AEB", url: "https://www.gov.br/aeb", p1: "A Agência Espacial Brasileira (AEB) confirmou em 12 de janeiro a perda total do nanossatélite Aldebaran-I. O foguete indiano PSLV-C62 sofreu uma anomalia crítica no terceiro estágio, impedindo a inserção orbital.", p2: "O incidente resultou na perda de 16 satélites, incluindo 5 brasileiros. A AEB e a ISRO investigam falhas no sistema de ignição superior. O monitoramento costeiro nacional sofrerá atrasos estratégicos.", p3: "Apesar do revés, a AEB destaca a validação dos processos de engenharia nacionais. O foco agora é buscar novos lançadores para os modelos de engenharia remanescentes, mantendo o programa de soberania de dados." },
            { id: 2, title: "Estudantes do DF: Satélite Perdido na Índia", sector: "aero", scope: "national", date: "09/01/2026", impact: 8, readiness: 9, source: "G1", url: "https://g1.globo.com", p1: "Alunos de 16 escolas do DF viram seu satélite educacional ser perdido na falha do foguete indiano. O projeto visava democratizar o acesso ao espaço para jovens cientistas.", p2: "Os estudantes participaram de todo o ciclo de engenharia, programando subsistemas reais. O hardware estava a bordo do voo PSLV-C62 que falhou em atingir a órbita em 12 de janeiro.", p3: "O legado pedagógico permanece. A Secretaria de Educação manterá o programa, utilizando a experiência de falha real como aprendizado sobre a complexidade e risco do setor aeroespacial." },
            { id: 3, title: "Artemis 2: NASA Confirma Janela de Fevereiro", sector: "aero", scope: "international", date: "12/01/2026", impact: 10, readiness: 9, source: "SpaceNews", url: "https://spacenews.com", p1: "A NASA reafirmou o lançamento da Artemis 2 para fevereiro de 2026. Será a primeira missão tripulada a orbitar a Lua no século XXI, testando os limites da cápsula Orion.", p2: "Testes finais de redundância no Centro Kennedy mostram estabilidade nos sistemas de suporte à vida. A segurança da tripulação é o foco absoluto antes da contagem regressiva final.", p3: "O sucesso validará tecnologias para o pouso da Artemis 3. O mundo observa atentamente, pois esta missão redefine a presença humana no espaço profundo." },
            { id: 4, title: "ESA: Reavaliação da Missão ExoMars", sector: "aero", scope: "international", date: "05/01/2026", impact: 9, readiness: 7, source: "Aerospace America", url: "https://aerospaceamerica.aiaa.org", p1: "A ESA iniciou 2026 reestruturando a missão ExoMars para garantir autonomia tecnológica. Novos sistemas de pouso europeus estão sendo desenvolvidos para substituir parcerias anteriores.", p2: "O ano é 'mission-dense' para a Europa, com foco em satélites climáticos e de segurança. A logística em Kourou está operando em capacidade máxima para atender à demanda.", p3: "A capacidade de adaptação definirá a relevância da ESA na década. A busca por soberania em componentes críticos é a nova diretriz estratégica do continente." },
            { id: 5, title: "NASA Pandora: Ciência com CubeSats", sector: "aero", scope: "international", date: "10/01/2026", impact: 8, readiness: 8, source: "NASA Science", url: "https://science.nasa.gov", p1: "A missão Pandora usa CubeSats para estudar atmosferas de exoplanetas. O foco é entender como a atividade estelar afeta a habitabilidade em sistemas vizinhos.", p2: "Espectroscopia avançada em satélites pequenos permite diferenciar sinais atmosféricos de ruído estelar. É um avanço na ciência de alta precisão com baixo custo.", p3: "O lançamento em 2026 prova que o 'New Space' atingiu a ciência fundamental. A NASA expandirá o uso de plataformas modulares para astrofísica." },
            { id: 6, title: "Marinha: Início da Operação Aspirantex 2026", sector: "defense", scope: "national", date: "12/01/2026", impact: 7, readiness: 10, source: "Marinha do Brasil", url: "https://marinha.mil.br", p1: "A Marinha iniciou a Aspirantex 2026 com 2.400 militares. A missão adestra aspirantes e testa a prontidão da esquadra entre o Sudeste e Nordeste brasileiro.", p2: "Exercícios de tiro e manobras táticas validam sistemas de combate. A operação é vital para a formação da nova geração de oficiais da Armada.", p3: "A presença naval reforça a soberania na Amazônia Azul. Os resultados aprimoram a doutrina de defesa frente a ameaças contemporâneas." },
            { id: 7, title: "Uruguai: Chegada dos Super Tucanos", sector: "aero", scope: "international", date: "12/01/2026", impact: 9, readiness: 10, source: "Embraer", url: "https://embraer.com", p1: "A Embraer entregou os primeiros A-29 Super Tucano ao Uruguai. A frota moderniza a defesa aérea do país para combate ao tráfego ilícito.", p2: "O contrato inclui treinamento e suporte logístico integrado. A interoperabilidade regional é fortalecida com a adoção de plataformas brasileiras.", p3: "O Brasil consolida liderança na exportação de defesa na América Latina. O Uruguai ganha capacidade real de policiamento do espaço aéreo." },
            { id: 8, title: "Alistamento 2026: Foco em Mulheres", sector: "defense", scope: "national", date: "01/01/2026", impact: 6, readiness: 10, source: "Defesa", url: "https://gov.br/defesa", p1: "Começou o alistamento 2026 com destaque para vagas voluntárias femininas. As Forças Armadas buscam ampliar a representatividade em áreas técnicas.", p2: "O processo é digital e obrigatório para homens de 18 anos. As mulheres têm 1.467 vagas específicas em especialidades operacionais.", p3: "A modernização do sistema garante agilidade na mobilização. O serviço militar continua sendo uma ferramenta vital de formação cívica." },
            { id: 9, title: "NATO: Conferência de Segurança em Bruxelas", sector: "defense", scope: "international", date: "13/01/2026", impact: 9, readiness: 9, source: "NATO News", url: "https://nato.int", p1: "Mark Rutte liderou discussões sobre ameaças híbridas no Parlamento Europeu. A modernização militar é a prioridade da aliança para 2026.", p2: "Foco em defesa aérea integrada e proteção de infraestruturas críticas. A cooperação OTAN-UE é vista como pilar da estabilidade global.", p3: "Decisões moldarão os orçamentos de defesa do biênio. A proteção contra sabotagem e ciberataques é a nova linha de frente." },
            { id: 10, title: "AEB: Programa Incuba Espaço", sector: "aero", scope: "national", date: "12/01/2026", impact: 6, readiness: 8, source: "AEB", url: "https://gov.br/aeb", p1: "AEB lançou o 'Incuba Espaço' para startups de dados orbitais. O objetivo é fomentar soluções nacionais para agricultura e gestão urbana.", p2: "Startups terão mentoria e acesso a laboratórios. A iniciativa busca reduzir dependência de tecnologia estrangeira no processamento de dados.", p3: "O programa catalisa o ecossistema 'New Space' brasileiro. Espera-se gerar inovação aplicável à economia real ainda este ano." },
            { id: 11, title: "FAB: Concurso EAGS 2026 Aberto", sector: "defense", scope: "national", date: "08/01/2026", impact: 5, readiness: 10, source: "FAB", url: "https://fab.mil.br", p1: "Inscrições abertas para o EAGS 2026 da Aeronáutica. O concurso seleciona sargentos especialistas em eletrônica, enfermagem e administração.", p2: "Formação na EEAR em Guaratinguetá é referência técnica. O processo é vital para manter a prontidão operacional das bases aéreas.", p3: "A FAB busca renovar quadros com profissionais técnicos de alta capacidade. O concurso é um dos mais concorridos do setor de defesa." },
            { id: 12, title: "Embraer e Mahindra: C-390 na Índia", sector: "aero", scope: "international", date: "12/01/2026", impact: 10, readiness: 7, source: "InfoMoney", url: "https://infomoney.com.br", p1: "Embraer avança em acordo com Mahindra para fabricar o C-390 na Índia. O projeto visa substituir a frota de transporte tático indiana.", p2: "Foco no programa 'Make in India' com transferência de tecnologia. O C-390 superou concorrentes em testes de pista rústica.", p3: "Expansão agressiva da base industrial brasileira na Ásia. O contrato pode garantir décadas de produção e relevância geopolítica." },
            { id: 13, title: "US Navy: Apreensão no Mar Vermelho", sector: "defense", scope: "international", date: "07/01/2026", impact: 8, readiness: 10, source: "Reuters", url: "https://reuters.com", p1: "Marinha dos EUA apreendeu navios violando sanções comerciais. Ação visa cortar financiamento de instabilidades regionais.", p2: "Vigilância intensificada em rotas estratégicas. A operação foi rápida e sem resistência, mas elevou alertas de segurança.", p3: "Demonstração de força no controle de corredores marítimos. O cumprimento do direito internacional permanece como prioridade naval." },
            { id: 14, title: "SpaceX: Missão Pandora (Rideshare)", sector: "aero", scope: "international", date: "11/01/2026", impact: 7, readiness: 10, source: "SpaceX", url: "https://spacex.com", p1: "Sucesso no lançamento da missão Pandora com Falcon 9. Dezenas de pequenos satélites colocados em órbita para clientes globais.", p2: "Rideshare democratiza o acesso ao espaço com custos reduzidos. Todos os artefatos reportaram telemetria nominal após separação.", p3: "SpaceX mantém liderança com reuso eficiente. Cronograma de 2026 segue intenso com foco em constelações comerciais." }
        ];

        // --- STATE MANAGEMENT ---
        let appData = [...initialData];
        let rejectedIds = [];
        let currentFilter = { sector: 'all', search: '' };
        let charts = { timeline: null, matrix: null };

        // --- FUNÇÕES DE API ---
        function getApiKey() {
            return localStorage.getItem('gemini_api_key') || '';
        }

        function openConfig() {
            const modal = document.getElementById('configModal');
            document.getElementById('apiKeyInput').value = getApiKey();
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function saveConfig() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if(key) {
                localStorage.setItem('gemini_api_key', key);
                alert("Chave API salva com sucesso!");
                document.getElementById('configModal').classList.add('hidden');
                document.getElementById('configModal').classList.remove('flex');
            } else {
                alert("Por favor, insira uma chave válida.");
            }
        }

        // --- CLEAN JSON HELPER ---
        function cleanJson(text) {
            // Tenta encontrar o array JSON dentro de markdown ou texto
            const firstBracket = text.indexOf('[');
            const lastBracket = text.lastIndexOf(']');
            if (firstBracket !== -1 && lastBracket !== -1) {
                return text.substring(firstBracket, lastBracket + 1);
            }
            return text; // Tenta parsear direto se não achar brackets
        }

        async function syncWithAI() {
            const apiKey = getApiKey();
            if (!apiKey) {
                openConfig();
                return;
            }

            const btn = document.getElementById('syncBtn');
            const overlay = document.getElementById('aiOverlay');
            
            // UI State
            btn.disabled = true;
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
            
            try {
                // Contexto
                const knownTitles = appData.map(d => d.title).join("; ");
                
                const prompt = `
                    Atue como um analista de inteligência sênior em Aeroespacial e Defesa.
                    Busque novas notícias REAIS e VERIFICÁVEIS de JANEIRO DE 2026.
                    NÃO repita estas notícias: ${knownTitles}.
                    
                    REQUISITO CRÍTICO DE FORMATO:
                    Para cada notícia, gere um JSON com:
                    title, sector (aero/defense), scope (national/international), date (DD/MM/2026), 
                    source, url, summary, 
                    p1 (Contexto - parágrafo longo de 60-80 palavras), 
                    p2 (Detalhes Técnicos - parágrafo longo de 60-80 palavras), 
                    p3 (Impacto Estratégico - parágrafo longo de 60-80 palavras),
                    impact (1-10), readiness (1-10).
                    
                    Retorne APENAS o JSON array. Sem markdown, sem introdução.
                `;

                // IMPLEMENTAÇÃO DE RETRY PARA CORRIGIR ERRO 429
                let response;
                let retries = 3;
                let delay = 2000;

                while(retries > 0) {
                    try {
                        response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: prompt }] }],
                                tools: [{ google_search: {} }] 
                            })
                        });

                        if (response.status === 429) throw new Error("429");
                        if (!response.ok) throw new Error("API Error: " + response.status);
                        break; // Sucesso

                    } catch (e) {
                        if (e.message === "429") {
                            console.warn("Rate limit. Retrying in " + delay + "ms");
                            await new Promise(r => setTimeout(r, delay));
                            delay *= 2; // Exponential backoff
                            retries--;
                        } else {
                            throw e;
                        }
                    }
                }

                if (!response) throw new Error("Falha na conexão após retentativas.");

                const data = await response.json();
                
                // --- SANITIZAÇÃO CRÍTICA DO JSON ---
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    throw new Error("Resposta da IA vazia ou inválida.");
                }

                let rawText = data.candidates[0].content.parts[0].text;
                let cleanText = cleanJson(rawText);
                
                let newItems;
                try {
                    newItems = JSON.parse(cleanText);
                } catch (e) {
                    console.error("Falha ao parsear JSON limpo:", cleanText);
                    throw new Error("A resposta da IA não é um JSON válido.");
                }
                
                // Integração
                let addedCount = 0;
                newItems.forEach(item => {
                    if (!appData.some(d => d.title === item.title)) {
                        item.id = Date.now() + Math.random();
                        appData.push(item);
                        addedCount++;
                    }
                });

                if(addedCount > 0) alert(`${addedCount} novos relatórios de inteligência adicionados com sucesso.`);
                else alert("Nenhum fato novo relevante encontrado no momento.");

            } catch (error) {
                console.error(error);
                if(error.message.includes("429")) {
                    alert("Limite de uso da API excedido. Aguarde 1 minuto e tente novamente.");
                } else {
                    alert("Erro: " + error.message);
                }
            } finally {
                btn.disabled = false;
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
                renderFeed();
                updateCharts();
            }
        }

        // --- RENDERIZAÇÃO ---
        function renderFeed() {
            const grid = document.getElementById('newsGrid');
            const filtered = appData.filter(d => {
                if (rejectedIds.includes(d.id)) return false;
                const matchSec = currentFilter.sector === 'all' || d.sector === currentFilter.sector;
                const matchSearch = (d.title + d.source + d.summary).toLowerCase().includes(currentFilter.search);
                return matchSec && matchSearch;
            });

            if (filtered.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                document.getElementById('emptyState').classList.add('flex');
                grid.innerHTML = '';
                return;
            }

            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('flex');

            grid.innerHTML = filtered.sort((a,b) => new Date(b.date.split('/').reverse().join('-')) - new Date(a.date.split('/').reverse().join('-'))).map(item => `
                <div onclick="openModal(${item.id})" class="pro-card p-8 cursor-pointer group animate-fade-in">
                    <button onclick="event.stopPropagation(); rejectItem(${item.id})" class="absolute top-4 right-4 text-slate-300 hover:text-red-500 transition-colors z-10 p-2" title="Marcar como Irrelevante">
                        <i class="fa-solid fa-ban"></i>
                    </button>
                    <div class="flex items-center gap-3 mb-6">
                        <span class="text-[10px] font-black uppercase tracking-widest px-3 py-1 rounded ${item.sector === 'aero' ? 'bg-aero-surface text-aero-DEFAULT' : 'bg-lime-50 text-def-DEFAULT'}">
                            ${item.sector === 'aero' ? 'AERO' : 'DEFESA'}
                        </span>
                        <span class="text-[10px] font-bold text-slate-400 font-mono">${item.date}</span>
                    </div>
                    <h3 class="text-lg font-black text-slate-900 leading-tight mb-4 group-hover:text-aero-DEFAULT transition-colors">
                        ${item.title}
                    </h3>
                    <p class="text-xs text-slate-500 font-medium leading-relaxed line-clamp-3">
                        ${item.summary || item.p1.substring(0, 120) + '...'}
                    </p>
                    <div class="mt-6 pt-4 border-t border-slate-50 flex justify-between items-center">
                        <span class="text-[9px] font-bold text-slate-400 uppercase tracking-wider">${item.source}</span>
                        <i class="fa-solid fa-arrow-right text-slate-300 group-hover:text-aero-DEFAULT group-hover:translate-x-1 transition-transform"></i>
                    </div>
                </div>
            `).join('');
        }

        function filterData(sec) {
            currentFilter.sector = sec;
            ['all', 'aero', 'defense'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                if (t === sec) {
                    btn.className = "flex-1 md:flex-none px-8 py-3 rounded-xl text-xs font-black transition-all bg-slate-900 text-white shadow-lg transform scale-105";
                } else {
                    btn.className = "flex-1 md:flex-none px-8 py-3 rounded-xl text-xs font-black transition-all text-slate-500 hover:text-slate-900";
                }
            });
            renderFeed();
            updateCharts();
        }

        function rejectItem(id) {
            rejectedIds.push(id);
            renderFeed();
            updateCharts();
        }

        function openModal(id) {
            const item = appData.find(d => d.id === id);
            if (!item) return;

            const m = document.getElementById('newsModal');
            document.getElementById('modalTitle').innerText = item.title;
            document.getElementById('modalSector').innerText = item.sector === 'aero' ? 'AEROESPACIAL' : 'DEFESA';
            document.getElementById('modalSector').className = `px-4 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-widest border ${item.sector === 'aero' ? 'border-aero-DEFAULT text-aero-DEFAULT' : 'border-def-DEFAULT text-def-DEFAULT'}`;
            document.getElementById('modalScope').innerText = item.scope === 'national' ? 'NACIONAL' : 'INTERNACIONAL';
            
            document.getElementById('modalBody').innerHTML = `
                <p>${item.p1}</p>
                <p>${item.p2}</p>
                <p>${item.p3}</p>
            `;
            
            document.getElementById('modalSource').innerText = item.source;
            document.getElementById('modalDate').innerText = item.date;
            document.getElementById('modalLink').href = item.url;
            
            // QR Code
            const qrBox = document.getElementById('qrcode');
            qrBox.innerHTML = '';
            new QRCode(qrBox, {
                text: item.url,
                width: 120,
                height: 120,
                colorDark : "#0f172a",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });

            m.classList.remove('hidden');
            m.classList.add('flex');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.getElementById('newsModal').classList.add('hidden');
            document.getElementById('newsModal').classList.remove('flex');
            document.body.style.overflow = 'auto';
        }

        // --- CHARTS ---
        function initCharts() {
            // Check if Chart is defined
            if (typeof Chart !== 'undefined') {
                const ctxT = document.getElementById('timelineChart').getContext('2d');
                charts.timeline = new Chart(ctxT, {
                    type: 'bar',
                    data: getTimelineData(),
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { display: false },
                            x: { grid: { display: false }, ticks: { font: { family: 'Inter', size: 10 } } }
                        },
                        borderRadius: 6
                    }
                });
            }

            // Scatter Chart (Plotly)
            updateMatrix();
        }

        function getTimelineData() {
            const counts = {};
            appData.filter(d => !rejectedIds.includes(d.id)).forEach(d => {
                const day = parseInt(d.date.split('/')[0], 10);
                counts[day] = (counts[day] || 0) + 1;
            });
            const days = Object.keys(counts).map(Number).sort((a,b) => a - b);
            return {
                labels: days.map(d => `Dia ${d}`),
                datasets: [{
                    data: days.map(d => counts[d]),
                    backgroundColor: '#0284c7'
                }]
            };
        }

        function updateMatrix() {
            const validData = appData.filter(d => !rejectedIds.includes(d.id));
            const traceAero = {
                x: validData.filter(d => d.sector === 'aero').map(d => d.readiness),
                y: validData.filter(d => d.sector === 'aero').map(d => d.impact),
                text: validData.filter(d => d.sector === 'aero').map(d => d.title),
                mode: 'markers',
                type: 'scatter',
                name: 'Aero',
                marker: { size: 14, color: '#0f4d7c', opacity: 0.7 },
                hoverinfo: 'text'
            };

            const traceDef = {
                x: validData.filter(d => d.sector === 'defense').map(d => d.readiness),
                y: validData.filter(d => d.sector === 'defense').map(d => d.impact),
                text: validData.filter(d => d.sector === 'defense').map(d => d.title),
                mode: 'markers',
                type: 'scatter',
                name: 'Defesa',
                marker: { size: 14, color: '#4d7c0f', opacity: 0.7 },
                hoverinfo: 'text'
            };

            const layout = {
                margin: { t: 20, r: 20, b: 40, l: 40 },
                showlegend: false,
                xaxis: { title: 'Maturidade (TRL)', range: [0, 11], gridcolor: '#f1f5f9', zeroline: false },
                yaxis: { title: 'Impacto', range: [0, 11], gridcolor: '#f1f5f9', zeroline: false },
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                font: { family: 'Inter', size: 10, color: '#64748b' }
            };

            if (typeof Plotly !== 'undefined') {
                Plotly.newPlot('strategicMap', [traceAero, traceDef], layout, {displayModeBar: false, responsive: true});
            }
        }

        function updateCharts() {
            if(charts.timeline) {
                charts.timeline.data = getTimelineData();
                charts.timeline.update();
            }
            updateMatrix();
        }

        // Init
        window.addEventListener('DOMContentLoaded', init);
        document.getElementById('searchInput').addEventListener('input', (e) => {
            currentFilter.search = e.target.value.toLowerCase();
            renderFeed();
        });

        function init() {
            renderFeed();
            initCharts();
        }

    </script>
</body>
</html>
